<!DOCTYPE html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=JamFox><link href=https://docs.jamfox.dev/content/devops/vaultad/ rel=canonical><link href=../kubernetes/ rel=prev><link href=../vaultkrb/ rel=next><link rel=icon href=../../../assets/icon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.0"><title>Hashicorp Vault integration with AD and SSH signing - JamFox's Documentation</title><link rel=stylesheet href=../../../assets/stylesheets/main.618322db.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script defer src=https://cloud.umami.is/script.js data-website-id=bead9d93-4ef7-4e94-b53b-c936abe55767></script><link href=../../../assets/stylesheets/glightbox.min.css rel=stylesheet><script src=../../../assets/javascripts/glightbox.min.js></script><style id=glightbox-style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=light-blue data-md-color-accent=light-blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#vault class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="JamFox's Documentation" class="md-header__button md-logo" aria-label="JamFox's Documentation" data-md-component=logo> <img src=../../../assets/icon.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> JamFox's Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Hashicorp Vault integration with AD and SSH signing </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=light-blue data-md-color-accent=light-blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"></path></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/JamFox/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class=md-source__repository> github.com/JamFox </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../homelab/ class=md-tabs__link> HomeLab </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../ class=md-tabs__link> DevOps </a> </li> <li class=md-tabs__item> <a href=../../food/ class=md-tabs__link> Food &amp; Drinks </a> </li> <li class=md-tabs__item> <a href=../../links/ class=md-tabs__link> Links </a> </li> <li class=md-tabs__item> <a href=../../extras/ class=md-tabs__link> Other </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="JamFox's Documentation" class="md-nav__button md-logo" aria-label="JamFox's Documentation" data-md-component=logo> <img src=../../../assets/icon.png alt=logo> </a> JamFox's Documentation </label> <div class=md-nav__source> <a href=https://github.com/JamFox/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class=md-source__repository> github.com/JamFox </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../homelab/ class=md-nav__link> <span class=md-ellipsis> HomeLab </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> DevOps </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> DevOps </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex> <span class=md-ellipsis> Version Control </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Version Control </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../semver/ class=md-nav__link> <span class=md-ellipsis> Semantic Versioning </span> </a> </li> <li class=md-nav__item> <a href=../gitbasics/ class=md-nav__link> <span class=md-ellipsis> Git For Beginners </span> </a> </li> <li class=md-nav__item> <a href=../gitdos/ class=md-nav__link> <span class=md-ellipsis> Git DOs &amp; DON'Ts </span> </a> </li> <li class=md-nav__item> <a href=../precommit/ class=md-nav__link> <span class=md-ellipsis> Precommit </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex> <span class=md-ellipsis> Performance Testing &amp; Benchmarking </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Performance Testing &amp; Benchmarking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../performance-testing-benchmarking/ class=md-nav__link> <span class=md-ellipsis> Performance Testing &amp; Benchmarking </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex> <span class=md-ellipsis> Configuration Management </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Configuration Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../saltstack-for-ansible/ class=md-nav__link> <span class=md-ellipsis> Ansible User's Guide to Saltstack </span> </a> </li> <li class=md-nav__item> <a href=../ansiblevault/ class=md-nav__link> <span class=md-ellipsis> Ansible Vault </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex> <span class=md-ellipsis> Provisioning </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Provisioning </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../packer/ class=md-nav__link> <span class=md-ellipsis> Hashicorp Packer </span> </a> </li> <li class=md-nav__item> <a href=../terraform/ class=md-nav__link> <span class=md-ellipsis> Hashicorp Terraform </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_6> <label class=md-nav__link for=__nav_3_6 id=__nav_3_6_label tabindex> <span class=md-ellipsis> GitLab </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_6_label aria-expanded=false> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> GitLab </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../packerci/ class=md-nav__link> <span class=md-ellipsis> OpenStack Packer GitLab CI/CD </span> </a> </li> <li class=md-nav__item> <a href=../gitlabrunnershare/ class=md-nav__link> <span class=md-ellipsis> Sharing Runners To Multiple Projects </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_7> <label class=md-nav__link for=__nav_3_7 id=__nav_3_7_label tabindex> <span class=md-ellipsis> Orchestration </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_7_label aria-expanded=false> <label class=md-nav__title for=__nav_3_7> <span class="md-nav__icon md-icon"></span> Orchestration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../orchestrationexplained/ class=md-nav__link> <span class=md-ellipsis> Orchestration Fundamentals Explained Simply </span> </a> </li> <li class=md-nav__item> <a href=../consul/ class=md-nav__link> <span class=md-ellipsis> Hashicorp Consul </span> </a> </li> <li class=md-nav__item> <a href=../nomad/ class=md-nav__link> <span class=md-ellipsis> Hashicorp Nomad </span> </a> </li> <li class=md-nav__item> <a href=../kubernetes/ class=md-nav__link> <span class=md-ellipsis> Kubernetes </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_8 checked> <label class=md-nav__link for=__nav_3_8 id=__nav_3_8_label tabindex> <span class=md-ellipsis> Secrets Management </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_8_label aria-expanded=true> <label class=md-nav__title for=__nav_3_8> <span class="md-nav__icon md-icon"></span> Secrets Management </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Vault with AD </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Vault with AD </span> </a> <nav class="md-nav md-nav--secondary" aria-label="On this page"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> On this page </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#vault class=md-nav__link> <span class=md-ellipsis> Vault </span> </a> <nav class=md-nav aria-label=Vault> <ul class=md-nav__list> <li class=md-nav__item> <a href=#first-setup-for-back-end class=md-nav__link> <span class=md-ellipsis> First setup for back-end </span> </a> </li> <li class=md-nav__item> <a href=#write-policies class=md-nav__link> <span class=md-ellipsis> Write policies </span> </a> </li> <li class=md-nav__item> <a href=#azure-ad-authentication-method-setup class=md-nav__link> <span class=md-ellipsis> Azure AD authentication method setup </span> </a> </li> <li class=md-nav__item> <a href=#keyvalue-version-1-engine-setup class=md-nav__link> <span class=md-ellipsis> Key/Value version 1 engine setup </span> </a> </li> <li class=md-nav__item> <a href=#userpass-authentication-method-setup class=md-nav__link> <span class=md-ellipsis> Userpass authentication method setup </span> </a> </li> <li class=md-nav__item> <a href=#client-ssh-key-signing-setup class=md-nav__link> <span class=md-ellipsis> Client SSH key signing setup </span> </a> <nav class=md-nav aria-label="Client SSH key signing setup"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#host-machines-setup class=md-nav__link> <span class=md-ellipsis> Host machine(s) setup </span> </a> </li> <li class=md-nav__item> <a href=#client-side-setup class=md-nav__link> <span class=md-ellipsis> Client side setup </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#host-ssh-key-signing-setup-not-tested-as-of-writing class=md-nav__link> <span class=md-ellipsis> Host SSH key signing setup (not tested as of writing) </span> </a> <nav class=md-nav aria-label="Host SSH key signing setup (not tested as of writing)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#client-side-host-verification class=md-nav__link> <span class=md-ellipsis> Client-Side Host Verification </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backup-setup class=md-nav__link> <span class=md-ellipsis> Backup setup </span> </a> </li> <li class=md-nav__item> <a href=#other-secret-engines-and-use-cases class=md-nav__link> <span class=md-ellipsis> Other secret engines and use cases </span> </a> <nav class=md-nav aria-label="Other secret engines and use cases"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#using-keyvalue-engine-as-a-way-to-track-and-renew-ssl-certs class=md-nav__link> <span class=md-ellipsis> Using Key/Value engine as a way to track and renew SSL certs </span> </a> </li> <li class=md-nav__item> <a href=#vault-engines-not-covered-in-test class=md-nav__link> <span class=md-ellipsis> Vault engines not covered in test </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#securitythreat-model class=md-nav__link> <span class=md-ellipsis> Security/Threat model </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../vaultkrb/ class=md-nav__link> <span class=md-ellipsis> Vault with Kerberos </span> </a> </li> <li class=md-nav__item> <a href=../sops/ class=md-nav__link> <span class=md-ellipsis> Mozilla SOPS </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../networking/ class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_10> <label class=md-nav__link for=__nav_3_10 id=__nav_3_10_label tabindex> <span class=md-ellipsis> Storage </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_10_label aria-expanded=false> <label class=md-nav__title for=__nav_3_10> <span class="md-nav__icon md-icon"></span> Storage </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ceph/ class=md-nav__link> <span class=md-ellipsis> Ceph </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_11> <label class=md-nav__link for=__nav_3_11 id=__nav_3_11_label tabindex> <span class=md-ellipsis> AI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_11_label aria-expanded=false> <label class=md-nav__title for=__nav_3_11> <span class="md-nav__icon md-icon"></span> AI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ai-build/ class=md-nav__link> <span class=md-ellipsis> Building AI </span> </a> </li> <li class=md-nav__item> <a href=../prompteng/ class=md-nav__link> <span class=md-ellipsis> Prompt Engineering </span> </a> </li> <li class=md-nav__item> <a href=../stablediffusion/ class=md-nav__link> <span class=md-ellipsis> Stable Diffusion </span> </a> </li> <li class=md-nav__item> <a href=../stablediffusion-ps1/ class=md-nav__link> <span class=md-ellipsis> Playstation Filter Using Stable Diffusion </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_12> <label class=md-nav__link for=__nav_3_12 id=__nav_3_12_label tabindex> <span class=md-ellipsis> Red Teaming &amp; Penetration Testing </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_12_label aria-expanded=false> <label class=md-nav__title for=__nav_3_12> <span class="md-nav__icon md-icon"></span> Red Teaming &amp; Penetration Testing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../redteaming/ class=md-nav__link> <span class=md-ellipsis> Red Teaming </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../food/ class=md-nav__link> <span class=md-ellipsis> Food &amp; Drinks </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../links/ class=md-nav__link> <span class=md-ellipsis> Links </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../extras/ class=md-nav__link> <span class=md-ellipsis> Other </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="On this page"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> On this page </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#vault class=md-nav__link> <span class=md-ellipsis> Vault </span> </a> <nav class=md-nav aria-label=Vault> <ul class=md-nav__list> <li class=md-nav__item> <a href=#first-setup-for-back-end class=md-nav__link> <span class=md-ellipsis> First setup for back-end </span> </a> </li> <li class=md-nav__item> <a href=#write-policies class=md-nav__link> <span class=md-ellipsis> Write policies </span> </a> </li> <li class=md-nav__item> <a href=#azure-ad-authentication-method-setup class=md-nav__link> <span class=md-ellipsis> Azure AD authentication method setup </span> </a> </li> <li class=md-nav__item> <a href=#keyvalue-version-1-engine-setup class=md-nav__link> <span class=md-ellipsis> Key/Value version 1 engine setup </span> </a> </li> <li class=md-nav__item> <a href=#userpass-authentication-method-setup class=md-nav__link> <span class=md-ellipsis> Userpass authentication method setup </span> </a> </li> <li class=md-nav__item> <a href=#client-ssh-key-signing-setup class=md-nav__link> <span class=md-ellipsis> Client SSH key signing setup </span> </a> <nav class=md-nav aria-label="Client SSH key signing setup"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#host-machines-setup class=md-nav__link> <span class=md-ellipsis> Host machine(s) setup </span> </a> </li> <li class=md-nav__item> <a href=#client-side-setup class=md-nav__link> <span class=md-ellipsis> Client side setup </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#host-ssh-key-signing-setup-not-tested-as-of-writing class=md-nav__link> <span class=md-ellipsis> Host SSH key signing setup (not tested as of writing) </span> </a> <nav class=md-nav aria-label="Host SSH key signing setup (not tested as of writing)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#client-side-host-verification class=md-nav__link> <span class=md-ellipsis> Client-Side Host Verification </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backup-setup class=md-nav__link> <span class=md-ellipsis> Backup setup </span> </a> </li> <li class=md-nav__item> <a href=#other-secret-engines-and-use-cases class=md-nav__link> <span class=md-ellipsis> Other secret engines and use cases </span> </a> <nav class=md-nav aria-label="Other secret engines and use cases"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#using-keyvalue-engine-as-a-way-to-track-and-renew-ssl-certs class=md-nav__link> <span class=md-ellipsis> Using Key/Value engine as a way to track and renew SSL certs </span> </a> </li> <li class=md-nav__item> <a href=#vault-engines-not-covered-in-test class=md-nav__link> <span class=md-ellipsis> Vault engines not covered in test </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#securitythreat-model class=md-nav__link> <span class=md-ellipsis> Security/Threat model </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/JamFox/docs.jamfox.dev/raw/master/docs/content/devops/vaultad.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"></path></svg> </a> <h1>Vault with AD</h1> <h2 id=vault>Vault<a class=headerlink href=#vault title="Anchor link to this section for reference">ඞ</a></h2> <p>Vault is an identity-based secrets and encryption management system. A secret is anything that you want to tightly control access to, such as API encryption keys, passwords, or certificates. Vault provides encryption services that are gated by authentication and authorization methods. Using Vault's UI, CLI, or HTTP API, access to secrets and other sensitive data can be securely stored and managed, tightly controlled (restricted), and auditable.</p> <p><a href=https://www.vaultproject.io/docs/what-is-vault>Hashicorp Vault documentation</a></p> <h3 id=first-setup-for-back-end>First setup for back-end<a class=headerlink href=#first-setup-for-back-end title="Anchor link to this section for reference">ඞ</a></h3> <p>Copy <code>vault.hcl</code> to <code>/etc/vault.d/</code> and start the back-end:</p> <ul> <li>Manually...</li> </ul> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a>sudo<span class=w> </span>nohup<span class=w> </span>vault<span class=w> </span>server<span class=w> </span>-config<span class=o>=</span>/etc/vault.d/vault.hcl<span class=w> </span>&gt;<span class=w> </span>/var/log/vault-manual.log<span class=w> </span><span class=p>&amp;</span>
</code></pre></div></td></tr></tbody></table></div> <ul> <li>...or as a systemd service</li> </ul> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a>sudo<span class=w> </span>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>vault.service<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>sudo<span class=w> </span>systemctl<span class=w> </span>start<span class=w> </span>vault.service
</code></pre></div></td></tr></tbody></table></div> <p>Then initialize the host and NOTE DOWN THE GENERATED KEYS:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a>vault<span class=w> </span>operator<span class=w> </span>init
</code></pre></div></td></tr></tbody></table></div> <p>Vault starts in a <a href=https://www.vaultproject.io/docs/concepts/seal>sealed state</a>, to unseal, use the following command three times:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a>vault<span class=w> </span>operator<span class=w> </span>unseal
</code></pre></div></td></tr></tbody></table></div> <p>Back-end should now be running and Vault should be unsealed.</p> <h3 id=write-policies>Write policies<a class=headerlink href=#write-policies title="Anchor link to this section for reference">ඞ</a></h3> <p>Create <code>hpc-default</code> policy. Applied to all logins with AD group <code>HPC Centre</code>:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a>vault<span class=w> </span>policy<span class=w> </span>write<span class=w> </span>hpc-default<span class=w> </span>hpc-default.hcl
</code></pre></div></td></tr></tbody></table></div> <h3 id=azure-ad-authentication-method-setup><a href=https://www.vaultproject.io/docs/auth/jwt/oidc_providers#azure-active-directory-aad>Azure AD authentication method</a> setup<a class=headerlink href=#azure-ad-authentication-method-setup title="Anchor link to this section for reference">ඞ</a></h3> <p>NOTE: users with over 200 groups might run into problems. Additional setup needed to accommodate users with over 200 groups. Check the relevant chapter in Vault official docs <a href=https://www.vaultproject.io/docs/auth/jwt/oidc_providers#optional-azure-specific-configuration>HERE</a>!</p> <p>Authenticate as root with the generated root token:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a>vault<span class=w> </span>login
</code></pre></div></td></tr></tbody></table></div> <p>Enable OIDC auth:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a>vault<span class=w> </span>auth<span class=w> </span><span class=nb>enable</span><span class=w> </span>oidc
</code></pre></div></td></tr></tbody></table></div> <p>Configure OIDC for Azure AD with the default role:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1> 1</a></span>
<span class=normal><a href=#__codelineno-7-2> 2</a></span>
<span class=normal><a href=#__codelineno-7-3> 3</a></span>
<span class=normal><a href=#__codelineno-7-4> 4</a></span>
<span class=normal><a href=#__codelineno-7-5> 5</a></span>
<span class=normal><a href=#__codelineno-7-6> 6</a></span>
<span class=normal><a href=#__codelineno-7-7> 7</a></span>
<span class=normal><a href=#__codelineno-7-8> 8</a></span>
<span class=normal><a href=#__codelineno-7-9> 9</a></span>
<span class=normal><a href=#__codelineno-7-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><span class=nv>AUTH0_DOMAIN</span><span class=o>=</span><span class=s2>"login.microsoftonline.com/&lt;YOUR-TENANT-ID-HERE&gt;/v2.0"</span>
<a id=__codelineno-7-2 name=__codelineno-7-2></a><span class=nv>AUTH0_CLIENT_ID</span><span class=o>=</span><span class=s2>"&lt;YOUR-AZURE-APP-ID-HERE&gt;"</span>
<a id=__codelineno-7-3 name=__codelineno-7-3></a><span class=nv>AUTH0_CLIENT_SECRET</span><span class=o>=</span><span class=s2>"&lt;YOUR-AZURE-APP-SECRET-HERE&gt;"</span>
<a id=__codelineno-7-4 name=__codelineno-7-4></a><span class=nv>AUTH0_DEFAULT_ROLE</span><span class=o>=</span><span class=s2>"aad"</span>
<a id=__codelineno-7-5 name=__codelineno-7-5></a>
<a id=__codelineno-7-6 name=__codelineno-7-6></a>vault<span class=w> </span>write<span class=w> </span>auth/oidc/config<span class=w> </span><span class=se>\</span>
<a id=__codelineno-7-7 name=__codelineno-7-7></a><span class=w>   </span><span class=nv>oidc_discovery_url</span><span class=o>=</span><span class=s2>"https://</span><span class=nv>$AUTH0_DOMAIN</span><span class=s2>"</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-7-8 name=__codelineno-7-8></a><span class=w>   </span><span class=nv>oidc_client_id</span><span class=o>=</span><span class=s2>"</span><span class=nv>$AUTH0_CLIENT_ID</span><span class=s2>"</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-7-9 name=__codelineno-7-9></a><span class=w>   </span><span class=nv>oidc_client_secret</span><span class=o>=</span><span class=s2>"</span><span class=nv>$AUTH0_CLIENT_SECRET</span><span class=s2>"</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-7-10 name=__codelineno-7-10></a><span class=w>   </span><span class=nv>default_role</span><span class=o>=</span><span class=s2>"</span><span class=nv>$AUTH0_DEFAULT_ROLE</span><span class=s2>"</span>
</code></pre></div></td></tr></tbody></table></div> <p>Configure the default role</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1> 1</a></span>
<span class=normal><a href=#__codelineno-8-2> 2</a></span>
<span class=normal><a href=#__codelineno-8-3> 3</a></span>
<span class=normal><a href=#__codelineno-8-4> 4</a></span>
<span class=normal><a href=#__codelineno-8-5> 5</a></span>
<span class=normal><a href=#__codelineno-8-6> 6</a></span>
<span class=normal><a href=#__codelineno-8-7> 7</a></span>
<span class=normal><a href=#__codelineno-8-8> 8</a></span>
<span class=normal><a href=#__codelineno-8-9> 9</a></span>
<span class=normal><a href=#__codelineno-8-10>10</a></span>
<span class=normal><a href=#__codelineno-8-11>11</a></span>
<span class=normal><a href=#__codelineno-8-12>12</a></span>
<span class=normal><a href=#__codelineno-8-13>13</a></span>
<span class=normal><a href=#__codelineno-8-14>14</a></span>
<span class=normal><a href=#__codelineno-8-15>15</a></span>
<span class=normal><a href=#__codelineno-8-16>16</a></span>
<span class=normal><a href=#__codelineno-8-17>17</a></span>
<span class=normal><a href=#__codelineno-8-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><span class=nv>AUTH0_USER_CLAIM</span><span class=o>=</span><span class=s2>"email"</span>
<a id=__codelineno-8-2 name=__codelineno-8-2></a><span class=nv>AUTH0_ALLOWED_REDIRECT_URI</span><span class=o>=</span><span class=s2>"http://localhost:8250/oidc/callback,</span><span class=nv>$VAULT_ADDR</span><span class=s2>/ui/vault/auth/oidc/oidc/callback"</span>
<a id=__codelineno-8-3 name=__codelineno-8-3></a><span class=nv>AUTH0_HPC_POLICY</span><span class=o>=</span><span class=s2>"default"</span>
<a id=__codelineno-8-4 name=__codelineno-8-4></a><span class=nv>AUTH0_TTL</span><span class=o>=</span><span class=s2>"1h"</span>
<a id=__codelineno-8-5 name=__codelineno-8-5></a><span class=nv>AUTH0_OIDC_SCOPES</span><span class=o>=</span><span class=s2>"profile"</span>
<a id=__codelineno-8-6 name=__codelineno-8-6></a><span class=nv>HPC_AZURE_GROUP_ID</span><span class=o>=</span><span class=s2>"&lt;YOUR-AZURE-APP-ID-HERE&gt;"</span>
<a id=__codelineno-8-7 name=__codelineno-8-7></a>
<a id=__codelineno-8-8 name=__codelineno-8-8></a>
<a id=__codelineno-8-9 name=__codelineno-8-9></a>vault<span class=w> </span>write<span class=w> </span>auth/oidc/role/aad<span class=w> </span>-<span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-8-10 name=__codelineno-8-10></a><span class=s>{</span>
<a id=__codelineno-8-11 name=__codelineno-8-11></a><span class=s>  "user_claim": "$AUTH0_USER_CLAIM",</span>
<a id=__codelineno-8-12 name=__codelineno-8-12></a><span class=s>  "allowed_redirect_uris": "$AUTH0_ALLOWED_REDIRECT_URI",</span>
<a id=__codelineno-8-13 name=__codelineno-8-13></a><span class=s>  "policies": "$AUTH0_HPC_POLICY",</span>
<a id=__codelineno-8-14 name=__codelineno-8-14></a><span class=s>  "ttl": "$AUTH0_TTL",</span>
<a id=__codelineno-8-15 name=__codelineno-8-15></a><span class=s>  "oidc_scopes": "$AUTH0_OIDC_SCOPES",</span>
<a id=__codelineno-8-16 name=__codelineno-8-16></a><span class=s>  "bound_claims": { "groups": ["$HPC_AZURE_GROUP_ID"] }</span>
<a id=__codelineno-8-17 name=__codelineno-8-17></a><span class=s>}</span>
<a id=__codelineno-8-18 name=__codelineno-8-18></a><span class=s>EOF</span>
</code></pre></div></td></tr></tbody></table></div> <p>Link default role and policy for users with AD group <code>HPC Centre</code>:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1> 1</a></span>
<span class=normal><a href=#__codelineno-9-2> 2</a></span>
<span class=normal><a href=#__codelineno-9-3> 3</a></span>
<span class=normal><a href=#__codelineno-9-4> 4</a></span>
<span class=normal><a href=#__codelineno-9-5> 5</a></span>
<span class=normal><a href=#__codelineno-9-6> 6</a></span>
<span class=normal><a href=#__codelineno-9-7> 7</a></span>
<span class=normal><a href=#__codelineno-9-8> 8</a></span>
<span class=normal><a href=#__codelineno-9-9> 9</a></span>
<span class=normal><a href=#__codelineno-9-10>10</a></span>
<span class=normal><a href=#__codelineno-9-11>11</a></span>
<span class=normal><a href=#__codelineno-9-12>12</a></span>
<span class=normal><a href=#__codelineno-9-13>13</a></span>
<span class=normal><a href=#__codelineno-9-14>14</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><span class=nv>AUTH0_ACCESSOR</span><span class=o>=</span><span class=k>$(</span>vault<span class=w> </span>auth<span class=w> </span>list<span class=w> </span>-format<span class=o>=</span>json<span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span>-r<span class=w> </span><span class=s1>'."oidc/".accessor'</span><span class=k>)</span>
<a id=__codelineno-9-2 name=__codelineno-9-2></a><span class=nv>HPC_VAULT_GROUP_NAME</span><span class=o>=</span><span class=s2>"HPC Centre"</span>
<a id=__codelineno-9-3 name=__codelineno-9-3></a><span class=nv>HPC_VAULT_GROUP_POLICY</span><span class=o>=</span><span class=s2>"hpc-default"</span>
<a id=__codelineno-9-4 name=__codelineno-9-4></a><span class=nv>HPC_VAULT_GROUP_ID</span><span class=o>=</span><span class=k>$(</span>vault<span class=w> </span>write<span class=w> </span><span class=se>\</span>
<a id=__codelineno-9-5 name=__codelineno-9-5></a><span class=w>   </span>-field<span class=o>=</span>id<span class=w> </span>-format<span class=o>=</span>table<span class=w> </span><span class=se>\</span>
<a id=__codelineno-9-6 name=__codelineno-9-6></a><span class=w>   </span>identity/group<span class=w> </span><span class=se>\</span>
<a id=__codelineno-9-7 name=__codelineno-9-7></a><span class=w>   </span><span class=nv>name</span><span class=o>=</span><span class=s2>"</span><span class=nv>$HPC_VAULT_GROUP_NAME</span><span class=s2>"</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-9-8 name=__codelineno-9-8></a><span class=w>   </span><span class=nv>type</span><span class=o>=</span><span class=s2>"external"</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-9-9 name=__codelineno-9-9></a><span class=w>   </span><span class=nv>policies</span><span class=o>=</span><span class=s2>"</span><span class=nv>$HPC_VAULT_GROUP_POLICY</span><span class=s2>"</span><span class=k>)</span>
<a id=__codelineno-9-10 name=__codelineno-9-10></a>
<a id=__codelineno-9-11 name=__codelineno-9-11></a>vault<span class=w> </span>write<span class=w> </span>identity/group-alias<span class=w> </span><span class=se>\</span>
<a id=__codelineno-9-12 name=__codelineno-9-12></a><span class=w>   </span><span class=nv>name</span><span class=o>=</span><span class=s2>"</span><span class=nv>$HPC_AZURE_GROUP_ID</span><span class=s2>"</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-9-13 name=__codelineno-9-13></a><span class=w>   </span><span class=nv>mount_accessor</span><span class=o>=</span><span class=s2>"</span><span class=nv>$AUTH0_ACCESSOR</span><span class=s2>"</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-9-14 name=__codelineno-9-14></a><span class=w>   </span><span class=nv>canonical_id</span><span class=o>=</span><span class=s2>"</span><span class=nv>$HPC_VAULT_GROUP_ID</span><span class=s2>"</span>
</code></pre></div></td></tr></tbody></table></div> <h3 id=keyvalue-version-1-engine-setup><a href=https://www.vaultproject.io/docs/secrets/kv/kv-v1>Key/Value version 1 engine</a> setup<a class=headerlink href=#keyvalue-version-1-engine-setup title="Anchor link to this section for reference">ඞ</a></h3> <p>The <code>kv</code> secrets engine is used to store arbitrary secrets within the configured physical storage for Vault. Writing to a key in the <code>kv</code> backend will replace the old value; sub-fields are not merged together.</p> <p>Enable a version 1 kv for personal secrets:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a>vault<span class=w> </span>secrets<span class=w> </span><span class=nb>enable</span><span class=w> </span>-path<span class=o>=</span><span class=s2>"personal"</span><span class=w> </span>kv
</code></pre></div></td></tr></tbody></table></div> <p>According to <code>hpc-default</code> policy:</p> <ul> <li>Every <code>HPC Centre</code> group user can store personal secrets that only they can modify and read at the templated path <code>personal/{{identity.entity.aliases.$AUTH0_ACCESSOR.name}}/*</code></li> <li>Every <code>HPC Centre</code> group user can create write-only secrets to any other users path <code>personal/*</code> (Existing values can not be modified/overwritten).</li> </ul> <p>Enable a version 1 kv for general secrets:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a>vault<span class=w> </span>secrets<span class=w> </span><span class=nb>enable</span><span class=w> </span>-path<span class=o>=</span><span class=s2>"secret"</span><span class=w> </span>kv
</code></pre></div></td></tr></tbody></table></div> <p>General secrets should follow a defined structure that is agreed upon beforehand. The more granular the paths are, the easier it will be to manage these secrets as the amount of secrets grows. In essence paths should be something like the following example:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1> 1</a></span>
<span class=normal><a href=#__codelineno-12-2> 2</a></span>
<span class=normal><a href=#__codelineno-12-3> 3</a></span>
<span class=normal><a href=#__codelineno-12-4> 4</a></span>
<span class=normal><a href=#__codelineno-12-5> 5</a></span>
<span class=normal><a href=#__codelineno-12-6> 6</a></span>
<span class=normal><a href=#__codelineno-12-7> 7</a></span>
<span class=normal><a href=#__codelineno-12-8> 8</a></span>
<span class=normal><a href=#__codelineno-12-9> 9</a></span>
<span class=normal><a href=#__codelineno-12-10>10</a></span>
<span class=normal><a href=#__codelineno-12-11>11</a></span>
<span class=normal><a href=#__codelineno-12-12>12</a></span>
<span class=normal><a href=#__codelineno-12-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a>secret/
<a id=__codelineno-12-2 name=__codelineno-12-2></a>├──<span class=w> </span>hpc-default/
<a id=__codelineno-12-3 name=__codelineno-12-3></a>│<span class=w>   </span>└──<span class=w> </span>base/
<a id=__codelineno-12-4 name=__codelineno-12-4></a>│<span class=w>        </span>└──<span class=w> </span><span class=nv>testsecret</span><span class=o>=</span><span class=s2>"Sup3rS3cr3t"</span>
<a id=__codelineno-12-5 name=__codelineno-12-5></a>│
<a id=__codelineno-12-6 name=__codelineno-12-6></a>├──<span class=w> </span>hpc-sysadmin/
<a id=__codelineno-12-7 name=__codelineno-12-7></a>│<span class=w>   </span>└──<span class=w> </span>clusters/
<a id=__codelineno-12-8 name=__codelineno-12-8></a>│<span class=w>        </span>├──<span class=w> </span>amp/
<a id=__codelineno-12-9 name=__codelineno-12-9></a>│<span class=w>        </span>├──<span class=w> </span>grey/
<a id=__codelineno-12-10 name=__codelineno-12-10></a>│<span class=w>        </span>└──<span class=w> </span>green/
<a id=__codelineno-12-11 name=__codelineno-12-11></a>│
<a id=__codelineno-12-12 name=__codelineno-12-12></a>└──<span class=w> </span>hpc-dev/
<a id=__codelineno-12-13 name=__codelineno-12-13></a><span class=w>    </span>└──<span class=w> </span>invenio/
</code></pre></div></td></tr></tbody></table></div> <h3 id=userpass-authentication-method-setup><a href=https://www.vaultproject.io/docs/auth/userpass>Userpass authentication method</a> setup<a class=headerlink href=#userpass-authentication-method-setup title="Anchor link to this section for reference">ඞ</a></h3> <p>The <code>userpass</code> auth method allows users to authenticate with Vault using a username and password combination.</p> <p>Userpasses have to be made manually and can then be linked with other entities, like the one generated by logging in via OIDC Azure AD method.</p> <p>Enable <code>userpass</code> auth method:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a>vault<span class=w> </span>auth<span class=w> </span><span class=nb>enable</span><span class=w> </span>userpass
</code></pre></div></td></tr></tbody></table></div> <p>Then create new user with a random password:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a>vault<span class=w> </span>write<span class=w> </span>auth/userpass/users/&lt;YOUR-USER-HERE&gt;<span class=w> </span><span class=nv>password</span><span class=o>=</span>&lt;RANDOM-PASS-HERE&gt;
</code></pre></div></td></tr></tbody></table></div> <p>And then link it with the users entity identity manually via the GUI from <code>Access &gt; Entities &gt; USERS-ENTITY &gt; Add alias</code> with <code>Name</code> field value as the same name as entered in the step before and with <code>Auth Backend</code> as <code>userpass/ (userpass)</code>.</p> <p>Then, according to <code>hpc-default</code> policy, the user can change their password with:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a>vault<span class=w> </span>write<span class=w> </span>auth/userpass/users/&lt;YOUR-USER-HERE&gt;<span class=w> </span><span class=nv>password</span><span class=o>=</span><span class=s2>"&lt;THEIR-NEW-PASS-HERE&gt;"</span>
</code></pre></div></td></tr></tbody></table></div> <h3 id=client-ssh-key-signing-setup><a href=https://www.hashicorp.com/blog/managing-ssh-access-at-scale-with-hashicorp-vault>Client SSH key signing</a> setup<a class=headerlink href=#client-ssh-key-signing-setup title="Anchor link to this section for reference">ඞ</a></h3> <p>Mount the <code>ssh-client-signer</code> secrets engine:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-16-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1></a>vault<span class=w> </span>secrets<span class=w> </span><span class=nb>enable</span><span class=w> </span>-path<span class=o>=</span>ssh-client-signer<span class=w> </span>ssh
</code></pre></div></td></tr></tbody></table></div> <p>Configure Vault with a CA for signing client keys using the <code>/config/ca</code> endpoint. If you do not have an internal CA, Vault can generate a keypair for you:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-17-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1></a>vault<span class=w> </span>write<span class=w> </span>ssh-client-signer/config/ca<span class=w> </span><span class=nv>generate_signing_key</span><span class=o>=</span><span class=nb>true</span>
</code></pre></div></td></tr></tbody></table></div> <p>If you already have a keypair, specify the public and private key parts as part of the payload:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-18-1>1</a></span>
<span class=normal><a href=#__codelineno-18-2>2</a></span>
<span class=normal><a href=#__codelineno-18-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1></a>vault<span class=w> </span>write<span class=w> </span>ssh-client-signer/config/ca<span class=w> </span><span class=se>\</span>
<a id=__codelineno-18-2 name=__codelineno-18-2></a><span class=w>    </span><span class=nv>private_key</span><span class=o>=</span><span class=s2>"..."</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-18-3 name=__codelineno-18-3></a><span class=w>    </span><span class=nv>public_key</span><span class=o>=</span><span class=s2>"..."</span>
</code></pre></div></td></tr></tbody></table></div> <h4 id=host-machines-setup>Host machine(s) setup<a class=headerlink href=#host-machines-setup title="Anchor link to this section for reference">ඞ</a></h4> <p>Add the public key to all target host's SSH configuration. This process can be manual or automated using a configuration management tool. The public key is accessible via the API and does not require authentication.</p> <p>Use:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-19-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1></a>curl<span class=w> </span>-o<span class=w> </span>/etc/ssh/trusted-user-ca-keys.pem<span class=w> </span><span class=nv>$VAULT_ADDR</span>/v1/ssh-client-signer/public_key
</code></pre></div></td></tr></tbody></table></div> <p>Or:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-20-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1></a>vault<span class=w> </span><span class=nb>read</span><span class=w> </span>-field<span class=o>=</span>public_key<span class=w> </span>ssh-client-signer/config/ca<span class=w> </span>&gt;<span class=w> </span>/etc/ssh/trusted-user-ca-keys.pem
</code></pre></div></td></tr></tbody></table></div> <p>Add the path where the public key contents are stored to the SSH configuration file at <code>/etc/ssh/sshd_config</code> as the <code>TrustedUserCAKeys</code> option:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-21-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1></a>TrustedUserCAKeys /etc/ssh/trusted-user-ca-keys.pem
</code></pre></div></td></tr></tbody></table></div> <p>Create AuthorizedPrincipalsFile file structure:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-22-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1></a>mkdir<span class=w> </span>/etc/ssh/auth_principals/
</code></pre></div></td></tr></tbody></table></div> <p>Create principals with users that can authenticate inside them. With this example <vault-user-here> can authenticate to <code>ubuntu@host</code>:</vault-user-here></p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-23-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1></a>sudo<span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=s2>"&lt;VAULT-USER-HERE&gt;"</span><span class=w> </span>&gt;<span class=w> </span>ubuntu
</code></pre></div></td></tr></tbody></table></div> <p>Add the path where the principals are stored to the SSH configuration file at <code>/etc/ssh/sshd_config</code> as the <code>AuthorizedPrincipalsFile</code> option:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-24-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1></a>AuthorizedPrincipalsFile<span class=w> </span>/etc/ssh/auth_principals/%u
</code></pre></div></td></tr></tbody></table></div> <p>It is good practice to also disable password auth via SSH at the configuration file at <code>/etc/ssh/sshd_config</code>:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-25-1>1</a></span>
<span class=normal><a href=#__codelineno-25-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1></a>ChallengeResponseAuthentication
<a id=__codelineno-25-2 name=__codelineno-25-2></a>noPasswordAuthentication no
</code></pre></div></td></tr></tbody></table></div> <p>Restart <code>sshd</code> service:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-26-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1></a>sudo<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>sshd
</code></pre></div></td></tr></tbody></table></div> <p>Then create separate roles for each user to have granular management over each user. NOTE: setting <code>algorithm_signer</code> is especially important (Valid values are <code>ssh-rsa</code>, <code>rsa-sha2-256</code>, and <code>rsa-sha2-512</code>), as <code>ssh-rsa</code> is the default but now considered insecure. Note that <code>allowed_users</code> controls the principals the Vault user is allowed to sign and connect with. If you need to restrict someone's SSH access, just change their roles <code>allowed_users</code> field. Example:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-27-1> 1</a></span>
<span class=normal><a href=#__codelineno-27-2> 2</a></span>
<span class=normal><a href=#__codelineno-27-3> 3</a></span>
<span class=normal><a href=#__codelineno-27-4> 4</a></span>
<span class=normal><a href=#__codelineno-27-5> 5</a></span>
<span class=normal><a href=#__codelineno-27-6> 6</a></span>
<span class=normal><a href=#__codelineno-27-7> 7</a></span>
<span class=normal><a href=#__codelineno-27-8> 8</a></span>
<span class=normal><a href=#__codelineno-27-9> 9</a></span>
<span class=normal><a href=#__codelineno-27-10>10</a></span>
<span class=normal><a href=#__codelineno-27-11>11</a></span>
<span class=normal><a href=#__codelineno-27-12>12</a></span>
<span class=normal><a href=#__codelineno-27-13>13</a></span>
<span class=normal><a href=#__codelineno-27-14>14</a></span>
<span class=normal><a href=#__codelineno-27-15>15</a></span>
<span class=normal><a href=#__codelineno-27-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1></a>vault<span class=w> </span>write<span class=w> </span>ssh-client-signer/roles/my-role<span class=w> </span>-&lt;&lt;<span class=s2>"EOH"</span>
<a id=__codelineno-27-2 name=__codelineno-27-2></a><span class=o>{</span>
<a id=__codelineno-27-3 name=__codelineno-27-3></a><span class=w>  </span><span class=s2>"algorithm_signer"</span>:<span class=w> </span><span class=s2>"rsa-sha2-512"</span>,
<a id=__codelineno-27-4 name=__codelineno-27-4></a><span class=w>  </span><span class=s2>"allow_user_certificates"</span>:<span class=w> </span>true,
<a id=__codelineno-27-5 name=__codelineno-27-5></a><span class=w>  </span><span class=s2>"allowed_users"</span>:<span class=w> </span><span class=s2>"*"</span>,
<a id=__codelineno-27-6 name=__codelineno-27-6></a><span class=w>  </span><span class=s2>"allowed_extensions"</span>:<span class=w> </span><span class=s2>"permit-pty,permit-port-forwarding"</span>,
<a id=__codelineno-27-7 name=__codelineno-27-7></a><span class=w>  </span><span class=s2>"default_extensions"</span>:<span class=w> </span><span class=o>[</span>
<a id=__codelineno-27-8 name=__codelineno-27-8></a><span class=w>    </span><span class=o>{</span>
<a id=__codelineno-27-9 name=__codelineno-27-9></a><span class=w>      </span><span class=s2>"permit-pty"</span>:<span class=w> </span><span class=s2>""</span>
<a id=__codelineno-27-10 name=__codelineno-27-10></a><span class=w>    </span><span class=o>}</span>
<a id=__codelineno-27-11 name=__codelineno-27-11></a><span class=w>  </span><span class=o>]</span>,
<a id=__codelineno-27-12 name=__codelineno-27-12></a><span class=w>  </span><span class=s2>"key_type"</span>:<span class=w> </span><span class=s2>"ca"</span>,
<a id=__codelineno-27-13 name=__codelineno-27-13></a><span class=w>  </span><span class=s2>"default_user"</span>:<span class=w> </span><span class=s2>"ubuntu"</span>,
<a id=__codelineno-27-14 name=__codelineno-27-14></a><span class=w>  </span><span class=s2>"ttl"</span>:<span class=w> </span><span class=s2>"8h"</span>
<a id=__codelineno-27-15 name=__codelineno-27-15></a><span class=o>}</span>
<a id=__codelineno-27-16 name=__codelineno-27-16></a>EOH
</code></pre></div></td></tr></tbody></table></div> <p>It is beneficial for SSH key signing roles use templating to avoid manual policy creations. At the time of writing <code>hpc-default.hcl</code> used <code>ssh-client-signer/sign/{{identity.entity.aliases.&lt;USERPASS-ACCESSOR-ID-HERE&gt;.name}}</code> for templating. Which means SSH key signing roles must match <code>userpass</code> auth method names (which also have to be created manually).</p> <h4 id=client-side-setup>Client side setup<a class=headerlink href=#client-side-setup title="Anchor link to this section for reference">ඞ</a></h4> <p>Ask Vault to sign your public key. <code>valid_principals</code> field MUST match <code>ssh-client-signer/sign/&lt;YOUR-ROLE-HERE&gt;</code> role's <code>allowed_users</code>:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-28-1>1</a></span>
<span class=normal><a href=#__codelineno-28-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1></a>vault<span class=w> </span>write<span class=w> </span>-field<span class=o>=</span>signed_key<span class=w> </span>ssh-client-signer/sign/sample-role<span class=w> </span><span class=se>\</span>
<a id=__codelineno-28-2 name=__codelineno-28-2></a><span class=w> </span><span class=nv>public_key</span><span class=o>=</span>@<span class=nv>$HOME</span>/.ssh/alice-key.pub<span class=w> </span><span class=nv>valid_principals</span><span class=o>=</span>sample<span class=w> </span>&gt;<span class=w> </span>~/.ssh/alice-signed-key.pub
</code></pre></div></td></tr></tbody></table></div> <p>To customize the signing options, use a JSON payload:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-29-1> 1</a></span>
<span class=normal><a href=#__codelineno-29-2> 2</a></span>
<span class=normal><a href=#__codelineno-29-3> 3</a></span>
<span class=normal><a href=#__codelineno-29-4> 4</a></span>
<span class=normal><a href=#__codelineno-29-5> 5</a></span>
<span class=normal><a href=#__codelineno-29-6> 6</a></span>
<span class=normal><a href=#__codelineno-29-7> 7</a></span>
<span class=normal><a href=#__codelineno-29-8> 8</a></span>
<span class=normal><a href=#__codelineno-29-9> 9</a></span>
<span class=normal><a href=#__codelineno-29-10>10</a></span>
<span class=normal><a href=#__codelineno-29-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1></a>vault<span class=w> </span>write<span class=w> </span>ssh-client-signer/sign/my-role<span class=w> </span>-&lt;&lt;<span class=s2>"EOH"</span>
<a id=__codelineno-29-2 name=__codelineno-29-2></a><span class=o>{</span>
<a id=__codelineno-29-3 name=__codelineno-29-3></a><span class=w>  </span><span class=s2>"public_key"</span>:<span class=w> </span><span class=s2>"ssh-rsa AAA..."</span>,
<a id=__codelineno-29-4 name=__codelineno-29-4></a><span class=w>  </span><span class=s2>"valid_principals"</span>:<span class=w> </span><span class=s2>"my-user"</span>,
<a id=__codelineno-29-5 name=__codelineno-29-5></a><span class=w>  </span><span class=s2>"key_id"</span>:<span class=w> </span><span class=s2>"custom-prefix"</span>,
<a id=__codelineno-29-6 name=__codelineno-29-6></a><span class=w>  </span><span class=s2>"extensions"</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-29-7 name=__codelineno-29-7></a><span class=w>    </span><span class=s2>"permit-pty"</span>:<span class=w> </span><span class=s2>""</span>,
<a id=__codelineno-29-8 name=__codelineno-29-8></a><span class=w>    </span><span class=s2>"permit-port-forwarding"</span>:<span class=w> </span><span class=s2>""</span>
<a id=__codelineno-29-9 name=__codelineno-29-9></a><span class=w>  </span><span class=o>}</span>
<a id=__codelineno-29-10 name=__codelineno-29-10></a><span class=o>}</span>
<a id=__codelineno-29-11 name=__codelineno-29-11></a>EOH
</code></pre></div></td></tr></tbody></table></div> <p>(Optional) View enabled extensions, principals, and metadata of the signed key:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-30-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1></a>ssh-keygen<span class=w> </span>-Lf<span class=w> </span>~/.ssh/signed-cert.pub
</code></pre></div></td></tr></tbody></table></div> <p>SSH into the host machine using the signed key. You must supply both the signed public key from Vault and the corresponding private key as authentication to the SSH call:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-31-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1></a>ssh<span class=w> </span>-i<span class=w> </span>signed-cert.pub<span class=w> </span>-i<span class=w> </span>~/.ssh/id_rsa<span class=w> </span>username@host
</code></pre></div></td></tr></tbody></table></div> <h3 id=host-ssh-key-signing-setup-not-tested-as-of-writing>Host SSH key signing setup (not tested as of writing)<a class=headerlink href=#host-ssh-key-signing-setup-not-tested-as-of-writing title="Anchor link to this section for reference">ඞ</a></h3> <p>Mount the <code>ssh-host-signer</code> secrets engine:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-32-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1></a>vault<span class=w> </span>secrets<span class=w> </span><span class=nb>enable</span><span class=w> </span>-path<span class=o>=</span>ssh-host-signer<span class=w> </span>ssh
</code></pre></div></td></tr></tbody></table></div> <p>Configure Vault with a CA for signing client keys using the <code>/config/ca</code> endpoint. If you do not have an internal CA, Vault can generate a keypair for you:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-33-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1></a>vault<span class=w> </span>write<span class=w> </span>ssh-host-signer/config/ca<span class=w> </span><span class=nv>generate_signing_key</span><span class=o>=</span><span class=nb>true</span>
</code></pre></div></td></tr></tbody></table></div> <p>If you already have a keypair, specify the public and private key parts as part of the payload:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-34-1>1</a></span>
<span class=normal><a href=#__codelineno-34-2>2</a></span>
<span class=normal><a href=#__codelineno-34-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1></a>vault<span class=w> </span>write<span class=w> </span>ssh-host-signer/config/ca<span class=w> </span><span class=se>\</span>
<a id=__codelineno-34-2 name=__codelineno-34-2></a><span class=w>    </span><span class=nv>private_key</span><span class=o>=</span><span class=s2>"..."</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-34-3 name=__codelineno-34-3></a><span class=w>    </span><span class=nv>public_key</span><span class=o>=</span><span class=s2>"..."</span>
</code></pre></div></td></tr></tbody></table></div> <p>Extend host key certificate TTLs:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-35-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1></a>vault<span class=w> </span>secrets<span class=w> </span>tune<span class=w> </span>-max-lease-ttl<span class=o>=</span>87600h<span class=w> </span>ssh-host-signer
</code></pre></div></td></tr></tbody></table></div> <p>Create a role for signing host keys. Be sure to fill in the list of allowed domains:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-36-1>1</a></span>
<span class=normal><a href=#__codelineno-36-2>2</a></span>
<span class=normal><a href=#__codelineno-36-3>3</a></span>
<span class=normal><a href=#__codelineno-36-4>4</a></span>
<span class=normal><a href=#__codelineno-36-5>5</a></span>
<span class=normal><a href=#__codelineno-36-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1></a>vault<span class=w> </span>write<span class=w> </span>ssh-host-signer/roles/hostrole<span class=w> </span><span class=se>\</span>
<a id=__codelineno-36-2 name=__codelineno-36-2></a><span class=w>    </span><span class=nv>key_type</span><span class=o>=</span>ca<span class=w> </span><span class=se>\</span>
<a id=__codelineno-36-3 name=__codelineno-36-3></a><span class=w>    </span><span class=nv>ttl</span><span class=o>=</span>87600h<span class=w> </span><span class=se>\</span>
<a id=__codelineno-36-4 name=__codelineno-36-4></a><span class=w>    </span><span class=nv>allow_host_certificates</span><span class=o>=</span><span class=nb>true</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-36-5 name=__codelineno-36-5></a><span class=w>    </span><span class=nv>allowed_domains</span><span class=o>=</span><span class=s2>"localdomain,example.com"</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-36-6 name=__codelineno-36-6></a><span class=w>    </span><span class=nv>allow_subdomains</span><span class=o>=</span><span class=nb>true</span>
</code></pre></div></td></tr></tbody></table></div> <p>Sign the host's SSH public key:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-37-1>1</a></span>
<span class=normal><a href=#__codelineno-37-2>2</a></span>
<span class=normal><a href=#__codelineno-37-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1></a>vault<span class=w> </span>write<span class=w> </span>ssh-host-signer/sign/hostrole<span class=w> </span><span class=se>\</span>
<a id=__codelineno-37-2 name=__codelineno-37-2></a><span class=w>    </span><span class=nv>cert_type</span><span class=o>=</span>host<span class=w> </span><span class=se>\</span>
<a id=__codelineno-37-3 name=__codelineno-37-3></a><span class=w>    </span><span class=nv>public_key</span><span class=o>=</span>@/etc/ssh/ssh_host_rsa_key.pub
</code></pre></div></td></tr></tbody></table></div> <p>Set the resulting signed certificate as <code>HostCertificate</code> in the SSH configuration on the host machine:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-38-1>1</a></span>
<span class=normal><a href=#__codelineno-38-2>2</a></span>
<span class=normal><a href=#__codelineno-38-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1></a>vault<span class=w> </span>write<span class=w> </span>-field<span class=o>=</span>signed_key<span class=w> </span>ssh-host-signer/sign/hostrole<span class=w> </span><span class=se>\</span>
<a id=__codelineno-38-2 name=__codelineno-38-2></a><span class=w>    </span><span class=nv>cert_type</span><span class=o>=</span>host<span class=w> </span><span class=se>\</span>
<a id=__codelineno-38-3 name=__codelineno-38-3></a><span class=w>    </span><span class=nv>public_key</span><span class=o>=</span>@/etc/ssh/ssh_host_rsa_key.pub<span class=w> </span>&gt;<span class=w> </span>/etc/ssh/ssh_host_rsa_key-cert.pub
</code></pre></div></td></tr></tbody></table></div> <p>Set permissions on the certificate to be <code>0640</code>:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-39-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1></a>chmod<span class=w> </span><span class=m>0640</span><span class=w> </span>/etc/ssh/ssh_host_rsa_key-cert.pub
</code></pre></div></td></tr></tbody></table></div> <p>Add host key and host certificate to the SSH configuration file at <code>/etc/ssh/sshd_config</code>:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Text Only</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-40-1>1</a></span>
<span class=normal><a href=#__codelineno-40-2>2</a></span>
<span class=normal><a href=#__codelineno-40-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1></a># For host keys
<a id=__codelineno-40-2 name=__codelineno-40-2></a>HostKey /etc/ssh/ssh_host_rsa_key
<a id=__codelineno-40-3 name=__codelineno-40-3></a>HostCertificate /etc/ssh/ssh_host_rsa_key-cert.pub
</code></pre></div></td></tr></tbody></table></div> <p>Restart <code>sshd</code> service:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-41-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1></a>sudo<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>sshd
</code></pre></div></td></tr></tbody></table></div> <h4 id=client-side-host-verification>Client-Side Host Verification<a class=headerlink href=#client-side-host-verification title="Anchor link to this section for reference">ඞ</a></h4> <p>Retrieve the host signing CA public key to validate the host signature of target machines.</p> <p>Use:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-42-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1></a>curl<span class=w> </span><span class=nv>$VAULT_ADDR</span>/v1/ssh-host-signer/public_key
</code></pre></div></td></tr></tbody></table></div> <p>Or:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-43-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1></a>vault<span class=w> </span><span class=nb>read</span><span class=w> </span>-field<span class=o>=</span>public_key<span class=w> </span>ssh-host-signer/config/ca
</code></pre></div></td></tr></tbody></table></div> <h3 id=backup-setup><a href="https://learn.hashicorp.com/tutorials/vault/raft-storage?in=vault/raft#data-snapshots-for-recovery">Backup</a> setup<a class=headerlink href=#backup-setup title="Anchor link to this section for reference">ඞ</a></h3> <p>This assumes that Raft is used as the storage back-end.</p> <p>Create a backup:</p> <ul> <li>Manually:</li> </ul> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-44-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1></a>vault<span class=w> </span>operator<span class=w> </span>raft<span class=w> </span>snapshot<span class=w> </span>save<span class=w> </span>demo.snapshot
</code></pre></div></td></tr></tbody></table></div> <ul> <li><a href=https://learn.hashicorp.com/tutorials/vault/sop-backup#automated-backup-procedures>Automatically with schedule</a> via CLI:</li> </ul> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-45-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1></a>vault<span class=w> </span>write<span class=w> </span>sys/storage/raft/snapshot-auto/config/daily<span class=w> </span><span class=nv>interval</span><span class=o>=</span><span class=s2>"24h"</span><span class=w> </span><span class=nv>retain</span><span class=o>=</span><span class=m>5</span><span class=w> </span><span class=nv>path_prefix</span><span class=o>=</span><span class=s2>"raft-backup"</span><span class=w> </span><span class=nv>storage_type</span><span class=o>=</span><span class=s2>"local"</span><span class=w> </span><span class=nv>local_max_space</span><span class=o>=</span><span class=m>1073741824</span>
</code></pre></div></td></tr></tbody></table></div> <p>Automatically with schedule with:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-46-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1></a>vault<span class=w> </span><span class=nb>read</span><span class=w> </span>sys/storage/raft/snapshot-auto/config/daily
</code></pre></div></td></tr></tbody></table></div> <p>Restore with:</p> <div class=highlight><table class=highlighttable><tbody><tr><th colspan=2 class=filename><span class=filename>Bash</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-47-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1></a>vault<span class=w> </span>operator<span class=w> </span>raft<span class=w> </span>snapshot<span class=w> </span>restore<span class=w> </span>demo.snapshot
</code></pre></div></td></tr></tbody></table></div> <h3 id=other-secret-engines-and-use-cases>Other secret engines and use cases<a class=headerlink href=#other-secret-engines-and-use-cases title="Anchor link to this section for reference">ඞ</a></h3> <p>Vault provides more secret engines and use cases that may be of use but were not covered in this test/demo.</p> <h4 id=using-keyvalue-engine-as-a-way-to-track-and-renew-ssl-certs>Using Key/Value engine as a way to track and renew SSL certs<a class=headerlink href=#using-keyvalue-engine-as-a-way-to-track-and-renew-ssl-certs title="Anchor link to this section for reference">ඞ</a></h4> <p>Certificates get issued after Let's Encrypt validates that users control the domain names in those certificates using the ACME API and "challenges". The most popular ones are the HTTP-01 and the DNS-01. The first requires users to get a particular file and serve it via HTTP or HTTPS, so that the Let's Encrypt servers are able to retrieve it. The latter uses DNS records respectively, so that Let's Encrypt can validate the domain ownership via queries. There are already many clients which ease both of those processes with EFF's Certbot being the most prominent one.</p> <p>Certbot supports certificate creation and renewal using both challenge types. For dealing with multiple domain names from one server, HTTP-01 challenges seem to be cumbersome: Certbot must serve some traffic on ports 80 and 443 for the Let's Encrypt servers to validate the domains. DNS-01 challenges are better on this perspective, but still this is not to be considered cloud-ready for two reasons:</p> <ul> <li>The certificate state is stored locally on the server</li> <li>The renewal process depends on a running cronjob of the same server</li> </ul> <p>To tackle with the first point, could still use Certbot, but store certificates, tokens etc. in Vault.</p> <h4 id=vault-engines-not-covered-in-test>Vault engines not covered in test<a class=headerlink href=#vault-engines-not-covered-in-test title="Anchor link to this section for reference">ඞ</a></h4> <p><a href=https://www.vaultproject.io/docs/secrets/databases>Database engine</a></p> <p>The database secrets engine generates database credentials dynamically based on configured roles. It works with a number of different databases through a plugin interface. There are a number of built-in database types, and an exposed framework for running custom database types for extendability. This means that <strong>services that need to access a database no longer need to hardcode credentials</strong>: they can request them from Vault, and use Vault's leasing mechanism to more easily roll keys. These are referred to as "dynamic roles" or "dynamic secrets".</p> <p>Since every service is accessing the database with unique credentials, it makes auditing much easier when questionable data access is discovered. You can track it down to the specific instance of a service based on the SQL username.</p> <p><a href=https://www.vaultproject.io/docs/secrets/pki>PKI Secrets Engine</a></p> <p>The PKI secrets engine generates dynamic X.509 certificates. With this secrets engine, services can get certificates without going through the usual manual process of generating a private key and CSR, submitting to a CA, and waiting for a verification and signing process to complete. Vault's built-in authentication and authorization mechanisms provide the verification functionality.</p> <p>By keeping TTLs relatively short, revocations are less likely to be needed, keeping CRLs short and helping the secrets engine scale to large workloads. This in turn allows each instance of a running application to have a unique certificate, eliminating sharing and the accompanying pain of revocation and rollover.</p> <p>In addition, by allowing revocation to mostly be forgone, this secrets engine allows for ephemeral certificates. Certificates can be fetched and stored in memory upon application startup and discarded upon shutdown, without ever being written to disk.</p> <p><a href=https://www.vaultproject.io/docs/secrets/transit>Transit Secrets Engine</a></p> <p>The transit secrets engine handles cryptographic functions on data in-transit. Vault doesn't store the data sent to the secrets engine. It can also be viewed as "cryptography as a service" or "encryption as a service". The transit secrets engine can also sign and verify data; generate hashes and HMACs of data; and act as a source of random bytes.</p> <p>The primary use case for transit is to encrypt data from applications while still storing that encrypted data in some primary data store. This relieves the burden of proper encryption/decryption from application developers and pushes the burden onto the operators of Vault.</p> <p>Key derivation is supported, which allows the same key to be used for multiple purposes by deriving a new key based on a user-supplied context value. In this mode, convergent encryption can optionally be supported, which allows the same input values to produce the same ciphertext.</p> <p>Datakey generation allows processes to request a high-entropy key of a given bit length be returned to them, encrypted with the named key. Normally this will also return the key in plaintext to allow for immediate use, but this can be disabled to accommodate auditing requirements.</p> <h3 id=securitythreat-model><a href=https://www.vaultproject.io/docs/internals/security#security-model>Security/Threat model</a><a class=headerlink href=#securitythreat-model title="Anchor link to this section for reference">ඞ</a></h3> <p>Some risks:</p> <ul> <li>Vault traffic might be eavesdropped</li> <li>Solution: Disable unencrypted HTTP comms, only use TLS encrypted traffic.</li> <li>User with signed SSH key might insert their own key to authorized keys list.</li> <li>Solution: Restrict machine user permissions.</li> <li>Solution: Schedule automatic SSH configuration deployment that clears dirs and inserts up-to-date configs to machines.</li> <li>Signed SSH key most likely TTL left after revoking SSH signing permissions.</li> <li>Solution: Admin generates new CA key.</li> <li>Authenticated user might have TTL left after revoking auth permissions.</li> <li>Solution: Disable/delete auth entity.</li> </ul> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://jamfox.dev/ target=_blank rel=noopener title=jamfox.dev class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M277.8 8.6c-12.3-11.4-31.3-11.4-43.5 0l-224 208c-9.6 9-12.8 22.9-8 35.1S18.8 272 32 272h16v176c0 35.3 28.7 64 64 64h288c35.3 0 64-28.7 64-64V272h16c13.2 0 25-8.1 29.8-20.3s1.6-26.2-8-35.1zM240 320h32c26.5 0 48 21.5 48 48v96H192v-96c0-26.5 21.5-48 48-48"></path></svg> </a> <a href=https://github.com/JamFox target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> <a href=https://www.linkedin.com/in/katurv/ target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"></path></svg> </a> <a href=https://www.instagram.com/karlturvas/ target=_blank rel=noopener title=www.instagram.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M224.3 141a115 115 0 1 0-.6 230 115 115 0 1 0 .6-230m-.6 40.4a74.6 74.6 0 1 1 .6 149.2 74.6 74.6 0 1 1-.6-149.2m93.4-45.1a26.8 26.8 0 1 1 53.6 0 26.8 26.8 0 1 1-53.6 0m129.7 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8M399 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1"></path></svg> </a> <a href=https://brain.jamfox.dev/ target=_blank rel=noopener title=brain.jamfox.dev class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M120 56c0-30.9 25.1-56 56-56h24c17.7 0 32 14.3 32 32v448c0 17.7-14.3 32-32 32h-32c-29.8 0-54.9-20.4-62-48h-2c-44.2 0-80-35.8-80-80 0-18 6-34.6 16-48-19.4-14.6-32-37.8-32-64 0-30.9 17.6-57.8 43.2-71.1-7.1-12-11.2-26-11.2-40.9 0-44.2 35.8-80 80-80zm272 0v24c44.2 0 80 35.8 80 80 0 15-4.1 29-11.2 40.9C486.5 214.2 504 241 504 272c0 26.2-12.6 49.4-32 64 10 13.4 16 30 16 48 0 44.2-35.8 80-80 80h-2c-7.1 27.6-32.2 48-62 48h-32c-17.7 0-32-14.3-32-32V32c0-17.7 14.3-32 32-32h24c30.9 0 56 25.1 56 56"></path></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["header.autohide", "navigation.tabs", "navigation.sections", "navigation.indexes", "navigation.top", "navigation.tabs.sticky", "content.tabs.link", "search.share", "content.code.annotate", "content.code.copy", "content.action.view", "navigation.indexes", "navigation.prune"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.e71a0d61.min.js></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../../../javascripts/tablesort.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>